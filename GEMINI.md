# プロジェクト状況

## 現在のアーキテクチャ：マイクロサービス構成（フェーズ2完了）
Next.js（Web/決済）と Express（PDF生成）を分離し、Cloud Run の 2 サービス体制に移行済み。

- **Webサーバー**: 軽量化・常時起動（min-instances: 1）。UIとStripe決済を担当。
- **PDFサーバー**: 重リソース・オンデマンド起動（min-instances: 0）。Puppeteer/JSXレンダリングを担当。
- **メリット**: Next.jsのAPI制限を回避し、PDF生成によるメインサイトへの負荷を隔離。

---

# 今後対応すべきこと

## 1. パフォーマンス最適化（PDFサーバー）
- **ブラウザのプール化**: 現在はリクエスト毎にブラウザを起動。負荷増大時は `puppeteer-cluster` 等を導入し、起動時間を短縮する。
- **フォントの軽量化**: 日本語フォントの読み込み速度の最適化。

## 2. 運用・保守の改善
- **環境変数の管理**: ローカル開発用に `.env.example` を整備し、`.env.local` で個別の秘密鍵（Stripe, API Key）を管理する。
- **決済フローの高度化**: 現在の「セッションID同期検証」でもセキュリティは確保されているが、将来的に「Webhook + DB」を導入することで、ブラウザ切断時の救済や購入後のサポート（再ダウンロード等）を可能にする。

## 3. フェーズ3：完全外部サービス化（必要に応じて）
- **Browserless.io 等の利用**: 自前でのブラウザ管理（Puppeteerのアップデート等）が負担になった場合、接続先を外部SaaSに変更するだけで移行可能。

---

## Gemini メモリ
- コードの修正前に必ず具体的な変更内容を提示し、事前の確認を得ること。
- PDF生成ロジックは `src/pdf-server` に隔離されており、Next.js側からは `PDF_SERVER_URL` 経由で呼び出す。
- **決済検証**: 現在は `stripe.checkout.sessions.retrieve` による同期検証。セキュリティ上はこれで完結している。
- **DB方針**: ログイン機能がないため、購入情報の永続化（サポート対応用）が必要になった段階で Firestore 等を導入検討する。
- **APIキー**: Web/PDF間の通信は `PDF_SERVER_API_KEY` で認可を行う。
